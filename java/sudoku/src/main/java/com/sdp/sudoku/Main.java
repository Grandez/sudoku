/*
 * This source file was generated by the Gradle 'init' task
 */
package com.sdp.sudoku;

import com.sdp.sudoku.config.CDG;
import com.sdp.sudoku.io.*;
import com.sdp.sudoku.boards.*;

import java.nio.file.Path;
import java.nio.file.Paths;

public class Main {
    Output out = Output.getInstance();
    long start = 0;
    long tree = 0;
    public static void main(String[] args) {
        Main app = new Main();
        int rc = app.playGame(args);
        System.exit(rc);
    }
    private int playGame(String[] args) {
        Input input = new Input();
        Integer[] data = input.load(args);
        Board board = prepareBoard(data);
        start = System.currentTimeMillis();
        int rc =  play(board);
        if (rc == CDG.DONE) System.out.println("Hecho! " + (System.currentTimeMillis() - start));
        if (rc == CDG.FAIL) System.out.println("FALLO!");
        return rc;
    }

    private int play (Board board) {
        Board pBoard;
        tree++;
        int rc = CDG.NEXT;
        while (rc == CDG.NEXT) {
            Square option = board.getCandidate();
            int card = option.cardinality();

            switch (card) {
                case 0: rc = CDG.DONE; break;
                case 1:
                    out.setMessage("Obtenida opcion de cardinalidad 1");
                    out.setMessage("Casilla: " + option.getPos());
                    roundSimple(board, option); break;
                default:
                    out.setMessage("Obtenida opcion de cardinalidad: " +  card);
                    out.setMessage("Casilla: " + option.getPos());
                    int i;
                    for (i = 0; i < card; i++) {
                        pBoard = board.copy();
                        board.bet(i);
                        // Ponemos el valor como unica opcion
                        if (play(pBoard) == CDG.DONE) break;
                    }
                    rc = (i == card) ? CDG.FAIL : CDG.DONE;
            }
        }
        return rc;
    }
    private Board prepareBoard(Integer[] data) {
        BoardFactory factory = new BoardFactory();

        Board board = factory.getBoard(data);
        board.init();
        out.setMessage("Situacion inicial");
        out.print(board.getCurrentBoard());
        return board;
    }
    private void roundSimple(Board board, Square option) {
        option.setValue();
        board.round(option);
        out.setMessage("Jugando casilla " + option.getPos());
        out.setMessage("Jugando valor " + option.getValue());
        out.print(board.getCurrentBoard());
    }
}
